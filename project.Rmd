<<<<<<< HEAD
---
title: "project"
author: "KangCheng Lin"
date: "December 3, 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###loading libraries
```{r}
library(ggplot2)
library(GGally)
library(dplyr)
library(purrr)
```

###loading dataset
```{r}
load("paintings_train.Rdata")
train <- paintings_train
```

###select variables
```{r}
#Professor's recoding
train <- train %>%
  mutate(shape_recode = ifelse(Shape == "", "Not Available",
                               ifelse(Shape == "ovale", "oval",
                                      ifelse(Shape == "ronde", "round",
                                             ifelse(Shape == "octogon", "octagon", Shape)))))

#recode
train <- train %>%
  mutate(mat_recode = ifelse(mat %in% c("a", "bc", "c","br"), "metal",
                      ifelse(mat %in% c("al", "ar", "m"), "stone",
                      ifelse(mat %in% c("co", "bt", "t","h","ta"), "canvas",
                      ifelse(mat %in% c("p", "ca"), "paper",
                      ifelse(mat %in% c("b"), "wood",
                      ifelse(mat %in% c("o", "e","v","mi","pa","g"), "other",
                      ifelse(mat %in% c("n/a", ""), "uncertain", NA))))))))

train <- train%>%
  mutate(fig_mention = ifelse(nfigures ==0, "no figures", "figures"))

train <- train%>%
  mutate(artist_living_notliving = ifelse(artistliving==0, "not living", "living"))

train <- train%>%
  mutate(history_nohistory = ifelse(history==0, "no history", "history"))

train <- train%>%
  mutate(mytho_nomytho = ifelse(mytho==0, "no mytho", "mytho"))

train <- train%>%
  mutate(finished_nofinished = ifelse(finished==0, "no finished", "finished"))

train <- train%>%
  mutate(LF = ifelse(finished==0, "no LF", "LF"))

#remove completely descriptive (thus irrelevant) variables
newTrain <- train[,!names(train) %in% c("sale","lot","position","logprice","subject",
                                        "authorstyle","authorstandard","author",
                                        "winningbidder",
                                        "Interm","Height_in","Width_in","Surface_Rect",
                                        "Diam_in","Surface_Rnd","material","mat",
                                        "lands_sc","lands_elem","lands_figs","lands_ment")]

#put price as the first column
newTrain <- newTrain[,c(7,1:6,8:46)]

#change price into numeric
newTrain$price <- as.numeric(gsub(",","",newTrain$price))

#NA
which(apply(newTrain,2,anyNA) == TRUE)
sum(is.na(newTrain$Surface))/nrow(newTrain)

#remove NA
newTrain <- newTrain[complete.cases(newTrain$Surface),]

#change all character strings to factors
character_vars <- lapply(newTrain, class) == "character"
newTrain[, character_vars] <- lapply(newTrain[, character_vars], as.factor)

levels(newTrain$type_intermed)[levels(newTrain$type_intermed)==""] <- "NONE"
levels(newTrain$winningbiddertype)[levels(newTrain$winningbiddertype)==""] <- "NONE"
levels(newTrain$endbuyer)[levels(newTrain$endbuyer)==""] <- "NONE"
levels(newTrain$materialCat)[levels(newTrain$materialCat)==""] <- "NONE"
levels(newTrain$school_pntg)[levels(newTrain$school_pntg)=="S"] <- "OTHER"
levels(newTrain$winningbiddertype)[levels(newTrain$winningbiddertype)=="EBC"] <- "OTHER"
```

###interaction
```{r}
#landsALL:paired
#dealer:prevcoll
#winningbiddertype:prevcoll
#winningbiddertype:artistliving
```

###raw analysis (w/o interactions)
```{r}
#logging price
m1 <- lm(log(price) ~ .,dat=newTrain)
#summary(m1)
#plot(m1,ask=FALSE)

#anova
#anova(m1)
```

###AIC
```{r}
#best_AIC <- step(m1,direction = "both",k=2)
#summary(best_AIC)
```

###BIC
```{r}
best_BIC <- step(m1,direction = "both",k=log(nrow(newTrain)))
summary(best_BIC)
```

###Testing Push
```{r}
#m <- lm(formula = log(price) ~ (dealer + year + school_pntg + diff_origin + 
#    artistliving + winningbiddertype + Surface + nfigures + engraved + 
#    prevcoll + othartist + paired + finished + lrgfont + othgenre + 
#    discauth)^2, data = newTrain)


#anova(m)

#m <- lm(formula = log(price) ~ dealer + year + school_pntg + diff_origin + 
#    winningbiddertype + Surface + nfigures + engraved + 
#    prevcoll + paired + finished + lrgfont + othgenre + 
#    discauth + landsALL:paired + 
#    dealer:prevcoll + winningbiddertype:prevcoll + 
#    winningbiddertype:artistliving, data = newTrain)

#anova(m)

#m <- lm(formula = log(price) ~ dealer + year + school_pntg + diff_origin + 
#    artistliving + winningbiddertype + Surface + nfigures + engraved + 
#    prevcoll + paired + finished + lrgfont + othgenre + discauth + 
#    dealer:year, data = newTrain)

#anova(m)

#m <- lm(formula = log(price) ~ dealer + year + school_pntg + diff_origin + 
#      winningbiddertype + Surface + nfigures + engraved + 
#      prevcoll + paired + finished + lrgfont + othgenre + discauth + 
#      dealer + landsALL:paired + dealer:prevcoll + 
#      winningbiddertype:prevcoll + winningbiddertype:artistliving, data = newTrain)

#m <- lm(formula = log(price) ~ dealer + year + school_pntg + diff_origin + 
#    artistliving + winningbiddertype + Surface + nfigures + engraved + 
#    prevcoll + paired + finished + lrgfont + othgenre + discauth + 
#    dealer:year, data = newTrain)

m <- lm(formula = log(price) ~ dealer + year + school_pntg + diff_origin + 
        artistliving + winningbiddertype + Surface + nfigures + engraved + 
        prevcoll + othartist + paired + finished + lrgfont + othgenre + 
        discauth + landsALL:paired + dealer:prevcoll + 
        winningbiddertype:prevcoll + winningbiddertype:artistliving +
        school_pntg:Surface + Surface:mat_recode, data = newTrain)
```

###testing dataset
```{r}
load("paintings_test.Rdata")
test <- paintings_test

#recode
test <- test %>%
  mutate(mat_recode = ifelse(mat %in% c("a", "bc", "c","br"), "metal",
                      ifelse(mat %in% c("al", "ar", "m"), "stone",
                      ifelse(mat %in% c("co", "bt", "t","h","ta"), "canvas",
                      ifelse(mat %in% c("p", "ca"), "paper",
                      ifelse(mat %in% c("b"), "wood",
                      ifelse(mat %in% c("o", "e","v","mi","pa","g"), "other",
                      ifelse(mat %in% c("n/a", ""), "uncertain", NA))))))))

test <- test%>%
  mutate(fig_mention = ifelse(nfigures ==0, "no figures", "figures"))

test <- test%>%
  mutate(artist_living_notliving = ifelse(artistliving==0, "not living", "living"))

test <- test%>%
  mutate(history_nohistory = ifelse(history==0, "no history", "history"))

test <- test%>%
  mutate(mytho_nomytho = ifelse(mytho==0, "no mytho", "mytho"))

test <- test%>%
  mutate(finished_nofinished = ifelse(finished==0, "no finished", "finished"))

test <- test%>%
  mutate(LF = ifelse(finished==0, "no LF", "LF"))


#Professor's recoding
test <- test %>%
  mutate(shape_recode = ifelse(Shape == "", "Not Available",
                               ifelse(Shape == "ovale", "oval",
                                      ifelse(Shape == "ronde", "round",
                                             ifelse(Shape == "octogon", "octagon", Shape)))))

newTest <- test[,!names(test) %in% c("sale","lot","position","logprice","subject",
                                        "authorstyle","authorstandard","author",
                                        "winningbidder", "price",
                                        "Interm","Height_in","Width_in","Surface_Rect",
                                        "Diam_in","Surface_Rnd","material","mat",
                                        "lands_sc","lands_elem","lands_figs","lands_ment")]

#change all character strings to factors
character_vars <- lapply(newTest, class) == "character"
newTest[, character_vars] <- lapply(newTest[, character_vars], as.factor)

levels(newTest$type_intermed)[levels(newTest$type_intermed)==""] <- "NONE"
levels(newTest$winningbiddertype)[levels(newTest$winningbiddertype)==""] <- "NONE"
levels(newTest$endbuyer)[levels(newTest$endbuyer)==""] <- "NONE"
levels(newTest$materialCat)[levels(newTest$materialCat)==""] <- "NONE"
levels(newTest$school_pntg)[levels(newTest$school_pntg)=="A"] <- "OTHER"
levels(newTest$school_pntg)[levels(newTest$school_pntg)=="G"] <- "OTHER"
levels(newTest$winningbiddertype)[levels(newTest$winningbiddertype)=="EBC"] <- "OTHER"
levels(newTest$winningbiddertype)[levels(newTest$winningbiddertype)=="BB"] <- "OTHER"
levels(newTest$winningbiddertype)[levels(newTest$winningbiddertype)=="ED"] <- "OTHER"

newTest$Surface[which(is.na(newTest$Surface)==TRUE)] <- mean(newTest$Surface, na.rm = TRUE)
```

```{r}
predictions = as.data.frame(
  exp(predict(m, newdata=newTest, 
              interval = "pred")))
save(predictions, file="predict-test.Rdata")
```
